<?php

require_once __DIR__ . '/../../webroot/inc/include.php';
require_once __DIR__ . '/../inc/testinclude.php';

class GetStatesTest extends baseAPITest
{
	protected $_aMPOINT_CONN_INFO;

	public function __construct()
	{
        parent::__construct();
		$this->constHTTPClient();
	}

	public function constHTTPClient()
	{
		global $aMPOINT_CONN_INFO;
		$aMPOINT_CONN_INFO['path'] = "/mConsole/api/get-states.php";
		$aMPOINT_CONN_INFO["contenttype"] = "application/x-www-form-urlencoded";
		$aMPOINT_CONN_INFO["method"] = "GET";
		$this->_aMPOINT_CONN_INFO = $aMPOINT_CONN_INFO;
		$this->_httpClient = new HTTPClient(new Template(), HTTPConnInfo::produceConnInfo($aMPOINT_CONN_INFO) );
	}

	public function testGetStates()
	{
        $this->queryDB("INSERT INTO Client.Client_Tbl (id, flowid, countryid, name, username, passwd) VALUES (10099, 1, 100, 'Test Client', 'Tusername', 'Tpassword')");
        $this->queryDB("INSERT INTO Client.URL_Tbl (clientid, urltypeid, url) VALUES (10099, 4, 'http://mpoint.local.cellpointmobile.com/')");
        $this->queryDB("INSERT INTO Client.Account_Tbl (id, clientid) VALUES (1100, 10099)");
        $this->queryDB("INSERT INTO Client.Keyword_Tbl (id, clientid, name, standard) VALUES (1, 10099, 'CPM', true)");

        $this->_httpClient->connect();
        $iStatus = $this->_httpClient->send($this->constHTTPHeaders('Tusername', 'Tpassword'));
        $sReplyBody = $this->_httpClient->getReplyBody();

        $this->assertEquals(200, $iStatus);
        $this->assertEquals('<?xml version="1.0" encoding="UTF-8"?><root><states><state><id>2000</id><name>Payment authorized by PSP</name></state><state><id>2001</id><name>Payment captured by PSP</name></state><state><id>2002</id><name>Payment Cancelled</name></state><state><id>2003</id><name>Payment Refunded</name></state><state><id>2010</id><name>Payment rejected by PSP</name><sub_states><state><id>2010101</id><name>Failed during Capture</name></state><state><id>2010102</id><name>Card Number is invalid.</name></state><state><id>2010103</id><name>Installment field value is invalid</name></state><state><id>2010104</id><name>Invalid Order Number value</name></state><state><id>2010105</id><name>Missing Mandatory Fields / Data not present / invalid data field (general error code when any field is invalid)</name></state><state><id>2010106</id><name>Invalid MerchantID</name></state><state><id>2010107</id><name>Invalid TransactionID</name></state><state><id>2010108</id><name>Invalid Transaction date</name></state><state><id>2010109</id><name>Invalid CVC</name></state><state><id>2010110</id><name>Invalid Payment Type</name></state><state><id>2010112</id><name>Invalid Expiry Date</name></state><state><id>2010113</id><name>Invalid 3DS Secure values</name></state><state><id>2010114</id><name>Invalid Card type</name></state><state><id>2010115</id><name>Invalid Request version</name></state><state><id>2010116</id><name>Return URL is not set.</name></state><state><id>2010117</id><name>Invalid currency code.</name></state><state><id>2010201</id><name>Failed during Cancel</name></state><state><id>2010202</id><name>Invalid PIN OR OTP</name></state><state><id>2010203</id><name>Insufficient funds / over credit limit</name></state><state><id>2010204</id><name>Expired Card</name></state><state><id>2010205</id><name>Unable to authorize</name></state><state><id>2010206</id><name>Exceeds withdrawal count limit OR Authentication requested</name></state><state><id>2010207</id><name>Do Not Honor</name></state><state><id>2010208</id><name>Transaction not permitted to user</name></state><state><id>2010209</id><name>Transaction Aborted by user / Card Holder Abandoned 3DS/Wallet</name></state><state><id>2010210</id><name>User Inactive or Session Expired</name></state><state><id>2010211</id><name>Only a partial amount was approved</name></state><state><id>2010301</id><name>Internal error / general system error</name></state><state><id>2010302</id><name>Parse error / invalid Request</name></state><state><id>2010303</id><name>Service not available.</name></state><state><id>2010304</id><name>Time out</name></state><state><id>2010305</id><name>Payment is cancelled / Payment reversed</name></state><state><id>2010306</id><name>Waiting for upstream response</name></state><state><id>2010307</id><name>No Routing Available</name></state><state><id>2010308</id><name>System DB Error</name></state><state><id>2010309</id><name>Invalid Operation / Operation Rejected</name></state><state><id>2010310</id><name>Transaction already in progress /  Duplicate Transaction / Duplicate Order Number</name></state><state><id>2010311</id><name>Endpoint not supported</name></state><state><id>2010312</id><name>Transaction not permitted to terminal</name></state><state><id>2010313</id><name>Invalid merchant account / configuration / API permission missing</name></state><state><id>2010314</id><name>Transaction rejected by Issuer / Authorization failed /Transaction Failed</name></state><state><id>2010315</id><name>EMI not available</name></state><state><id>2010316</id><name>Void not supported</name></state><state><id>2010317</id><name>Already Captured</name></state><state><id>2010318</id><name>Retry limit exceeded</name></state><state><id>2010319</id><name>Invalid Capture attempted</name></state><state><id>2010320</id><name>Transaction Not Posted</name></state><state><id>2010321</id><name>Recurring Payment Not Supported</name></state><state><id>2010322</id><name>Stored card option is disabled.</name></state><state><id>2010323</id><name>Request Authentication Failed.</name></state><state><id>2010324</id><name>Unable to decrypt request.</name></state><state><id>2010325</id><name>Transaction ID / EP Generation Failed</name></state><state><id>2010326</id><name>Installment Payment is disabled.</name></state><state><id>2010327</id><name>Ticket issue failed</name></state><state><id>2010328</id><name>China Union Pay sign failed</name></state><state><id>2010329</id><name>Card type is not allowed.</name></state><state><id>2010330</id><name>Issuing bank unavailable. </name></state><state><id>2010331</id><name>Transaction exceeds the approved limit </name></state><state><id>2010332</id><name>Cannot void as capture or credit is submitted </name></state><state><id>2010333</id><name>Cannot Refund / You requested a credit for a capture that was previously voided.</name></state><state><id>2010334</id><name>Credit amount exceeds maximum allowed for your Merchant account.</name></state><state><id>2010401</id><name>FRAUD Suspicion / Rejected</name></state><state><id>2010402</id><name>Address verification failed</name></state><state><id>2010403</id><name>Card Acceptor should contact accquirer</name></state><state><id>2010404</id><name>Security Voilation</name></state><state><id>2010405</id><name>Card is Blocked due to fraud</name></state><state><id>2010406</id><name>3D Secure authentication failed</name></state><state><id>2010407</id><name>Fraud Stolen Card</name></state><state><id>2010408</id><name>Compliance ERROR</name></state><state><id>2010409</id><name>Transaction Previously declined</name></state><state><id>2010410</id><name>E-commerce declined</name></state><state><id>2010411</id><name>Card restricted</name></state><state><id>2010412</id><name>Card Function Not Supported</name></state><state><id>2010413</id><name>Physical Card Error</name></state><state><id>2010414</id><name>BIN check failed</name></state><state><id>2010415</id><name>Validation Check Failed.</name></state><state><id>2010416</id><name>CVN did not match </name></state><state><id>2010417</id><name>The customer matched an entry on the processorâ€™s negative file.</name></state><state><id>2010418</id><name>Strong customer authentication (SCA) is required for this transaction.</name></state><state><id>2010419</id><name>authorization request was approved by the issuing bank but declined by Gateway/processor</name></state></sub_states></state><state><id>2011</id><name>Payment declined</name></state><state><id>2019</id><name>Payment duplicated</name></state><state><id>4010</id><name>Session Expire</name></state><state><id>4020</id><name>Session Decline (fail)</name></state><state><id>4030</id><name>Session Complete</name></state><state><id>4031</id><name>Session Partially Completed</name></state></states></root>', $sReplyBody);
	}
}