<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
    objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

    <!-- Temporarily drop event trigger to enable changes to replicated tables -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-09-master-v2.25-pre-process">

        <sql dbms="postgresql" endDelimiter=";">
            DROP EVENT TRIGGER IF EXISTS no_ddl_allowed
        </sql>
    </changeSet>

    <!-- Detach partitions -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-20-master-v2.25-CMP-4673-1">

        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists catalogName="log"
                    schemaName= "log"
                    tableName="TxnPassbook_Tbl_Default" />
            </not>
        </preConditions>

        <sql dbms="postgresql" endDelimiter=";">
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10021; -- SGA
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10022; -- Ethiopian Airlines
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10060; -- Music Planet Live
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10061; -- Sunrise Airways
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10062; -- MiRide
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10065; -- MiMeeting
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10066; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10067; -- E-Visa
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10070; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10071; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10072; -- Ethiopian Holidays
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10073; -- GOL Airways
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10074; -- Viva Airways Colombia
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10075; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10076; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10077; -- CEBU Pacific Air
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10078; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10079; -- UATP_Test_Client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10080; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10081; -- Viva Airways Peru
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10089; -- Non-Existant client
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10098; -- Farah Experiences
            ALTER TABLE Log.TxnPassbook_Tbl DETACH PARTITION Log.TxnPassbook_Tbl_10099; -- CPM Live
        </sql>
        <rollback>
            <sql>
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10021 FOR VALUES IN (10021); -- SGA
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10022 FOR VALUES IN (10022); -- Ethiopian Airlines
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10060 FOR VALUES IN (10060); -- Music Planet Live
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10061 FOR VALUES IN (10061); -- Sunrise Airways
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10062 FOR VALUES IN (10062); -- MiRide
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10065 FOR VALUES IN (10065); -- MiMeeting
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10066 FOR VALUES IN (10066); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10067 FOR VALUES IN (10067); -- E-Visa
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10070 FOR VALUES IN (10070); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10071 FOR VALUES IN (10071); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10072 FOR VALUES IN (10072); -- Ethiopian Holidays
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10073 FOR VALUES IN (10073); -- GOL Airways
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10074 FOR VALUES IN (10074); -- Viva Airways Colombia
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10075 FOR VALUES IN (10075); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10076 FOR VALUES IN (10076); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10077 FOR VALUES IN (10077); -- CEBU Pacific Air
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10078 FOR VALUES IN (10078); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10079 FOR VALUES IN (10079); -- UATP_Test_Client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10080 FOR VALUES IN (10080); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10081 FOR VALUES IN (10081); -- Viva Airways Peru
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10089 FOR VALUES IN (10089); -- Non-Existant client
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10098 FOR VALUES IN (10098); -- Farah Experiences
                ALTER TABLE Log.TxnPassbook_Tbl ATTACH PARTITION Log.TxnPassbook_Tbl_10099 FOR VALUES IN (10099); -- CPM Live
            </sql>
        </rollback>
    </changeSet>

    <!-- Create default partition for clients that are not part of the configuration data in Production or does no have a partition defined-->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-09-master-v2.25">

        <!-- Redefine foreign keys for log.settlement_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="settlement_tbl"  
            baseTableSchemaName="log"  
            constraintName="settlement_tbl_client_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="client_id"
            baseTableCatalogName="log"
            baseTableName="settlement_tbl"
            baseTableSchemaName="log"
            constraintName="settlement2client_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="settlement_tbl"  
            baseTableSchemaName="log"  
            constraintName="settlement_tbl_psp_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="psp_id"
            baseTableCatalogName="log"
            baseTableName="settlement_tbl"
            baseTableSchemaName="log"
            constraintName="settlement2psp_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="psp_tbl"
            referencedTableSchemaName="system" />

        <!-- Redefine foreign keys for log.externalreference_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="externalreference_tbl"  
            baseTableSchemaName="log"  
            constraintName="externalref2psp_fk" />
        <addForeignKeyConstraint
            baseColumnNames="pspid"
            baseTableCatalogName="log"
            baseTableName="externalreference_tbl"
            baseTableSchemaName="log"
            constraintName="externalreference2psp_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="psp_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="externalreference_tbl"  
            baseTableSchemaName="log"  
            constraintName="externalreferencetype_fk" />
        <addForeignKeyConstraint
            baseColumnNames="type"
            baseTableCatalogName="log"
            baseTableName="externalreference_tbl"
            baseTableSchemaName="log"
            constraintName="externalreference2externalreferencetype_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="externalreferencetype_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="externalreference_tbl"  
            baseTableSchemaName="log"  
            constraintName="externalref2txn_fk" />
        <addForeignKeyConstraint
            baseColumnNames="txnid"
            baseTableCatalogName="log"
            baseTableName="externalreference_tbl"
            baseTableSchemaName="log"
            constraintName="externalref2transaction_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="transaction_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.paymentroute_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="paymentroute_tbl"  
            baseTableSchemaName="log"  
            constraintName="pspid" />
        <addForeignKeyConstraint
            baseColumnNames="pspid"
            baseTableCatalogName="log"
            baseTableName="paymentroute_tbl"
            baseTableSchemaName="log"
            constraintName="paymentroute2psp_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="psp_tbl"
            referencedTableSchemaName="system" />

        <!-- Redefine foreign keys for log.order_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="order_tbl"  
            baseTableSchemaName="log"  
            constraintName="order2txn_fk" />
        <addForeignKeyConstraint
            baseColumnNames="txnid"
            baseTableCatalogName="log"
            baseTableName="order_tbl"
            baseTableSchemaName="log"
            constraintName="order2transaction_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="transaction_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.transaction_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="transaction_tbl"  
            baseTableSchemaName="log"  
            constraintName="convertedcurrency_fk" />
        <addForeignKeyConstraint
            baseColumnNames="convertedcurrencyid"
            baseTableCatalogName="log"
            baseTableName="transaction_tbl"
            baseTableSchemaName="log"
            constraintName="transaction2convertedcurrency_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="currency_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="transaction_tbl"  
            baseTableSchemaName="log"  
            constraintName="transaction_tbl_producttype_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="producttype"
            baseTableCatalogName="log"
            baseTableName="transaction_tbl"
            baseTableSchemaName="log"
            constraintName="transaction2producttype_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="producttype_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="transaction_tbl"  
            baseTableSchemaName="log"  
            constraintName="transaction_tbl_session_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="sessionid"
            baseTableCatalogName="log"
            baseTableName="transaction_tbl"
            baseTableSchemaName="log"
            constraintName="transaction2session_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="session_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.session_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_account_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="accountid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2account_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="account_tbl"
            referencedTableSchemaName="client" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_client_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2client_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_country_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="countryid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2country_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="country_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_currency_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="currencyid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2currency_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="currency_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_sessiontype_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="sessiontypeid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2sessiontype_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="sessiontype_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="session_tbl"  
            baseTableSchemaName="log"  
            constraintName="session_tbl_state_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="stateid"
            baseTableCatalogName="log"
            baseTableName="session_tbl"
            baseTableSchemaName="log"
            constraintName="session2state_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="state_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.txnpassbook_tbl -->
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="log"
            baseTableName="txnpassbook_tbl"
            baseTableSchemaName="log"
            constraintName="txnpassbook2client_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <addForeignKeyConstraint
            baseColumnNames="transactionid"
            baseTableCatalogName="log"
            baseTableName="txnpassbook_tbl"
            baseTableSchemaName="log"
            constraintName="txnpassbook2transaction_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="transaction_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.flight_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="flight_tbl"  
            baseTableSchemaName="log"  
            constraintName="arrival_countryid_country_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="arrival_countryid"
            baseTableCatalogName="log"
            baseTableName="flight_tbl"
            baseTableSchemaName="log"
            constraintName="arrival_country2country_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="country_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="flight_tbl"  
            baseTableSchemaName="log"  
            constraintName="departure_countryid_country_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="departure_countryid"
            baseTableCatalogName="log"
            baseTableName="flight_tbl"
            baseTableSchemaName="log"
            constraintName="departure_country2country_fk"
            onDelete="RESTRICT"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="country_tbl"
            referencedTableSchemaName="system" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="flight_tbl"  
            baseTableSchemaName="log"  
            constraintName="order_fk" />
        <addForeignKeyConstraint
            baseColumnNames="order_id"
            baseTableCatalogName="log"
            baseTableName="flight_tbl"
            baseTableSchemaName="log"
            constraintName="flight2order_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="order_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for log.settlement_record_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="settlement_record_tbl"  
            baseTableSchemaName="log"  
            constraintName="settlement_record_tbl_settlement_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="settlementid"
            baseTableCatalogName="log"
            baseTableName="settlement_record_tbl"
            baseTableSchemaName="log"
            constraintName="settlement_record2settlement_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="settlement_tbl"
            referencedTableSchemaName="log" />

        <dropForeignKeyConstraint
            baseTableCatalogName="log"  
            baseTableName="settlement_record_tbl"  
            baseTableSchemaName="log"  
            constraintName="settlement_record_tbl_transaction_tbl_id_fk" />
        <addForeignKeyConstraint
            baseColumnNames="transactionid"
            baseTableCatalogName="log"
            baseTableName="settlement_record_tbl"
            baseTableSchemaName="log"
            constraintName="settlement_record2transaction_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="log"
            referencedTableName="transaction_tbl"
            referencedTableSchemaName="log" />

        <!-- Redefine foreign keys for Client.gatewaystat_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaystat_tbl"  
            baseTableSchemaName="client"  
            constraintName="gatewaystat_fk" />
        <addForeignKeyConstraint
            baseColumnNames="gatewayid"
            baseTableCatalogName="client"
            baseTableName="gatewaystat_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaystat2psp_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="psp_tbl"
            referencedTableSchemaName="system" />
            
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaystat_tbl"  
            baseTableSchemaName="client"  
            constraintName="stattype_fk" />
        <addForeignKeyConstraint
            baseColumnNames="statetypeid"
            baseTableCatalogName="client"
            baseTableName="gatewaystat_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaystat2statisticstype_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="statisticstype_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaystat_tbl"  
            baseTableSchemaName="client"  
            constraintName="clientstat_fk" />
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="client"
            baseTableName="gatewaystat_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaystat2client_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <!-- Redefine foreign keys for Client.gatewaytrigger_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaytrigger_tbl"  
            baseTableSchemaName="client"  
            constraintName="gateway_fk" />
        <addForeignKeyConstraint
            baseColumnNames="gatewayid"
            baseTableCatalogName="client"
            baseTableName="gatewaytrigger_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaytrigger2psp_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="psp_tbl"
            referencedTableSchemaName="system" />
            
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaytrigger_tbl"  
            baseTableSchemaName="client"  
            constraintName="atriggerunit_fk" />
        <addForeignKeyConstraint
            baseColumnNames="aggregationtriggerunit"
            baseTableCatalogName="client"
            baseTableName="gatewaytrigger_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaytrigger2triggerunit_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="triggerunit_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="gatewaytrigger_tbl"  
            baseTableSchemaName="client"  
            constraintName="triggeclient_fk" />
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="client"
            baseTableName="gatewaytrigger_tbl"
            baseTableSchemaName="client"
            constraintName="gatewaytrigger2client_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <!-- Redefine foreign keys for Client.producttype_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="producttype_tbl"  
            baseTableSchemaName="client"  
            constraintName="product_fk" />
        <addForeignKeyConstraint
            baseColumnNames="productid"
            baseTableCatalogName="client"
            baseTableName="producttype_tbl"
            baseTableSchemaName="client"
            constraintName="producttype2producttype_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="producttype_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="producttype_tbl"  
            baseTableSchemaName="client"  
            constraintName="client_fk" />
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="client"
            baseTableName="producttype_tbl"
            baseTableSchemaName="client"
            constraintName="producttype2client_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <!-- Redefine foreign keys for Client.retrial_tbl -->
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="retrial_tbl"  
            baseTableSchemaName="client"  
            constraintName="retrialtype_fk" />
        <addForeignKeyConstraint
            baseColumnNames="typeid"
            baseTableCatalogName="client"
            baseTableName="retrial_tbl"
            baseTableSchemaName="client"
            constraintName="retrial2retrialtype_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="system"
            referencedTableName="retrialtype_tbl"
            referencedTableSchemaName="system" />
        
        <dropForeignKeyConstraint
            baseTableCatalogName="client"  
            baseTableName="retrial_tbl"  
            baseTableSchemaName="client"  
            constraintName="client_fk" />
        <addForeignKeyConstraint
            baseColumnNames="clientid"
            baseTableCatalogName="client"
            baseTableName="retrial_tbl"
            baseTableSchemaName="client"
            constraintName="retrial2client_fk"
            onDelete="CASCADE"
            onUpdate="CASCADE"
            referencedColumnNames="id"
            referencedTableCatalogName="client"
            referencedTableName="client_tbl"
            referencedTableSchemaName="client" />

        <sql dbms="postgresql" endDelimiter=";">
            -- Create default partition
            CREATE TABLE Log.TxnPassbook_Tbl_Default PARTITION OF Log.TxnPassbook_Tbl DEFAULT;
            
            -- Move data for low volume clients into default partition
            INSERT INTO Log.TxnPassbook_Tbl_Default SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid IN (SELECT clientid FROM Log.TxnPassBook_Tbl GROUP BY clientid HAVING Count(*) &lt; 200000);

            -- Drop partitions for low volume or non-existan clients
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10021; -- SGA
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10022; -- Ethiopian Airlines
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10060; -- Music Planet Live
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10061; -- Sunrise Airways
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10062; -- MiRide
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10065; -- MiMeeting
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10066; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10067; -- E-Visa
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10070; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10071; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10072; -- Ethiopian Holidays
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10073; -- GOL Airways
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10074; -- Viva Airways Colombia
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10075; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10076; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10077; -- CEBU Pacific Air
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10078; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10079; -- UATP_Test_Client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10080; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10081; -- Viva Airways Peru
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10089; -- Non-Existant client
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10098; -- Farah Experiences
            DROP TABLE IF EXISTS Log.TxnPassbook_Tbl_10099; -- CPM Live
        </sql>
        <rollback>
            <sql>
                -- SGA
                CREATE TABLE log.txnpassbook_tbl_10021 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10021);
                INSERT INTO Log.txnpassbook_tbl_10021 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10021;
                -- Ethiopian Airlines
                CREATE TABLE log.txnpassbook_tbl_10022 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10022);
                INSERT INTO Log.txnpassbook_tbl_10022 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10022;
                -- Music Planet Live
                CREATE TABLE log.txnpassbook_tbl_10060 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10060);
                INSERT INTO Log.txnpassbook_tbl_10060 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10060;
                -- Sunrise Airways
                CREATE TABLE log.txnpassbook_tbl_10061 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10061);
                INSERT INTO Log.txnpassbook_tbl_10061 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10061;
                -- MiRide
                CREATE TABLE log.txnpassbook_tbl_10062 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10062);
                INSERT INTO Log.txnpassbook_tbl_10062 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10062;
                -- MiMeeting
                CREATE TABLE log.txnpassbook_tbl_10065 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10065);
                INSERT INTO Log.txnpassbook_tbl_10065 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10065;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10066 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10066);
                INSERT INTO Log.txnpassbook_tbl_10066 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10066;
                -- E-Visa
                CREATE TABLE log.txnpassbook_tbl_10067 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10067);
                INSERT INTO Log.txnpassbook_tbl_10067 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10067;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10070 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10070);
                INSERT INTO Log.txnpassbook_tbl_10070 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10070;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10071 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10071);
                INSERT INTO Log.txnpassbook_tbl_10071 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10071;
                -- Ethiopian Holidays
                CREATE TABLE log.txnpassbook_tbl_10072 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10072);
                INSERT INTO Log.txnpassbook_tbl_10072 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10072;
                -- GOL Airways
                CREATE TABLE log.txnpassbook_tbl_10073 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10073);
                INSERT INTO Log.txnpassbook_tbl_10073 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10073;
                -- Viva Airways Colombia
                CREATE TABLE log.txnpassbook_tbl_10074 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10074);
                INSERT INTO Log.txnpassbook_tbl_10074 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10074;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10075 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10075);
                INSERT INTO Log.txnpassbook_tbl_10075 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10075;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10076 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10076);
                INSERT INTO Log.txnpassbook_tbl_10076 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10076;
                -- CEBU Pacific Air
                CREATE TABLE log.txnpassbook_tbl_10077 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10077);
                INSERT INTO Log.txnpassbook_tbl_10077 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10077;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10078 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10078);
                INSERT INTO Log.txnpassbook_tbl_10078 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10078;
                -- UATP_Test_Client
                CREATE TABLE log.txnpassbook_tbl_10079 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10079);
                INSERT INTO Log.txnpassbook_tbl_10079 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10079;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10080 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10080);
                INSERT INTO Log.txnpassbook_tbl_10080 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10080;
                -- Viva Airways Peru
                CREATE TABLE log.txnpassbook_tbl_10081 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10081);
                INSERT INTO Log.txnpassbook_tbl_10081 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10081;
                -- Non-Existant client
                CREATE TABLE log.txnpassbook_tbl_10089 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10089);
                INSERT INTO Log.txnpassbook_tbl_10089 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10089;
                -- Farah Experiences
                CREATE TABLE log.txnpassbook_tbl_10098 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10098);
                INSERT INTO Log.txnpassbook_tbl_10098 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10009;
                -- CPM Live
                CREATE TABLE log.txnpassbook_tbl_10099 PARTITION OF Log.TxnPassbook_tbl FOR VALUES IN (10099);
                INSERT INTO Log.txnpassbook_tbl_10099 SELECT * FROM Log.TxnPassbook_Tbl WHERE clientid = 10099;

                -- Drop default partition
                DROP TABLE Log.TxnPassbook_Tbl_Default;
            </sql>
        </rollback>
    </changeSet>

    <!-- Create index for default partition -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-10-master-v2.25-CMP-4673">

        <createIndex
            catalogName="log"
            indexName="idx_txnpassbook_tbl_default"
            schemaName="log"  
            tableName="txnpassbook_tbl_default"> 

            <column name="clientid" />
            <column name="transactionid" />
        </createIndex>  
    </changeSet>

    <!-- Create default partition for Southwest -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-11-master-v2.25-CMP-4694">

        <sql dbms="postgresql" endDelimiter=";"
            splitStatements="false">

            -- Create default partition for Southwest
            CREATE TABLE Log.TxnPassbook_Tbl_10069_Default PARTITION OF Log.TxnPassbook_Tbl_10069 DEFAULT;
        </sql>
        <rollback>
            <sql dbms="postgresql" endDelimiter=";"
                splitStatements="false">

                -- Drop default partition for Southwest
                DROP TABLE Log.TxnPassbook_Tbl_10069_Default;
            </sql>
        </rollback>
    </changeSet>

    <!-- Create primary keys for new default partition -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-20-master-v2.25-CMP-4673-2">

        <!-- A unique index is automatically created by postgres, when creating a primaryKey -->
        <addPrimaryKey catalogName="log"
                       schemaName="log"
                       tableName="TxnPassbook_Tbl_Default"
                       columnNames="id"
                       constraintName="TxnPassbook_Default_PK"/>

        <sql dbms="postgresql" endDelimiter=";"
            splitStatements="false">

            -- Create trigger for default partition
            CREATE TRIGGER update_txnpassbook_tbl_default
            BEFORE UPDATE 
            ON log.txnpassbook_tbl_default
            FOR EACH ROW
            EXECUTE PROCEDURE public.update_table_proc();
        </sql>
        <rollback>
            <sql dbms="postgresql" endDelimiter=";"
                splitStatements="false">

                -- Drop trigger for default partition
                DROP TRIGGER update_txnpassbook_tbl_default ON log.txnpassbook_tbl_default;
            </sql>
        </rollback>
    </changeSet>

    <!-- Create primary keys for new default partition for Southwest -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-20-master-v2.25-CMP-4694">

        <!-- A unique index is automatically created by postgres, when creating a primaryKey -->
        <addPrimaryKey catalogName="log"
                       schemaName="log"
                       tableName="TxnPassbook_Tbl_10069_Default"
                       columnNames="id"
                       constraintName="TxnPassbook_10069_Default_PK"/>

        <createIndex
            catalogName="log"
            indexName="idx_txnpassbook_tbl_10069_default"
            schemaName="log"  
            tableName="txnpassbook_tbl_10069_default"> 

            <column name="clientid" />
            <column name="transactionid" />
        </createIndex>

        <sql dbms="postgresql" endDelimiter=";"
            splitStatements="false">

            -- Create trigger for default Southwest partition
            CREATE TRIGGER update_txnpassbook_tbl_10069_default
            BEFORE UPDATE 
            ON log.txnpassbook_tbl_10069_default
            FOR EACH ROW
            EXECUTE PROCEDURE public.update_table_proc();
        </sql>
        <rollback>
            <sql dbms="postgresql" endDelimiter=";"
                splitStatements="false">

                -- Drop trigger for default Southwest partition
                DROP TRIGGER update_txnpassbook_tbl_10069_default ON log.txnpassbook_tbl_10069_default;
            </sql>
        </rollback>
    </changeSet>

    <!-- Recreate event trigger to disable changes to replicated tables -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-11-09-master-v2.25-post-process">

        <sql dbms="postgresql" endDelimiter=";">
            CREATE EVENT TRIGGER no_ddl_allowed ON ddl_command_end
            WHEN TAG IN ('ALTER TABLE')
            EXECUTE FUNCTION public.no_ddl()
        </sql>

        <sql dbms="postgresql" endDelimiter=";">
            ALTER EVENT TRIGGER no_ddl_allowed OWNER TO postgres
        </sql>
    </changeSet>
 
</databaseChangeLog>