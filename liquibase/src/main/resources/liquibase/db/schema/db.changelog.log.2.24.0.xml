<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <!-- Temporarily drop event trigger to enable changes to replicated tables -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-10-26-master-v2.24-pre-process">

        <sql dbms="postgresql" endDelimiter=";">
            DROP EVENT TRIGGER IF EXISTS no_ddl_allowed
        </sql>
    </changeSet>

    <!-- Ported from master_pg_v2.24.sql -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-10-26-master-v2.24-1">

<!-- The "code" column represents the Numeric ISO Code and the data type thus shouldn't be changed
        <modifyDataType catalogName="system"
            schemaName= "system"
            tableName="country_tbl"
            columnName="code"  
            newDataType="varchar(5)" />
-->

        <modifyDataType catalogName="log"
            schemaName= "log"
            tableName="txnpassbook_tbl"
            columnName="amount"  
            newDataType="bigint" />

    </changeSet>
    <!-- Ported from master_pg_v2.24.sql -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-10-26-master-v2.24-2">
        
        <preConditions onFail="MARK_RAN">
            <columnExists catalogName="log"
                schemaName= "log"
                tableName="transaction_tbl"
                columnName="convetredcurrencyid" />
        </preConditions>

        <renameColumn catalogName="log"
            schemaName= "log"
            tableName="transaction_tbl"
            oldColumnName="convetredcurrencyid"
            newColumnName="convertedcurrencyid" />

    </changeSet>

    <!-- Recreate event trigger to disable changes to replicated tables -->
    <changeSet author="Jonatan Evald Buus"
        id="2020-10-26-master-v2.24-postprocess">

        <sql dbms="postgresql" endDelimiter=";">
            CREATE EVENT TRIGGER no_ddl_allowed ON ddl_command_end
            WHEN TAG IN ('ALTER TABLE')
            EXECUTE FUNCTION public.no_ddl()
        </sql>

        <sql dbms="postgresql" endDelimiter=";">
            ALTER EVENT TRIGGER no_ddl_allowed OWNER TO postgres
        </sql>

    </changeSet>

</databaseChangeLog>